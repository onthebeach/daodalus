<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Daodalus by onthebeach</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Daodalus</h1>
        <p>DSL for building MongoDB queries, updates and aggregations</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/onthebeach/daodalus" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/onthebeach/daodalus/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/onthebeach/daodalus/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>
<a name="daodalus---" class="anchor" href="#daodalus---"><span class="octicon octicon-link"></span></a>DAODALUS  <a href="http://travis-ci.org/onthebeach/daodalus"><img src="https://travis-ci.org/onthebeach/daodalus.png" alt="Build Status"></a> <a href="https://codeclimate.com/github/onthebeach/daodalus"><img src="https://codeclimate.com/github/onthebeach/daodalus.png" alt="Code Climate"></a>
</h1>

<h3>
<a name="take-the-sting-out-of-constructing-complex-mongodb-queries-updates-and-aggregations" class="anchor" href="#take-the-sting-out-of-constructing-complex-mongodb-queries-updates-and-aggregations"><span class="octicon octicon-link"></span></a>Take the sting out of constructing complex MongoDB queries, updates and aggregations.</h3>

<p>In Greek mythology, Daedalus tried to prevent Icarus from flying too close to the sun, but Icarus ignored his father's warning, the wax holding together his wings melted, and he fell to his death. 'Daodalus' hopes to succeed where Daedalus failed by preventing your application code from flying too close to the code that interacts with your datastore.</p>

<p>Originally conceived of as an implementation of the Data Access Object pattern, it has evolved since then into more of a DSL to simplify doing complicated things with Mongo. However, by separating your models from the object used to interact with their stored form, we hope Daodalus still encourages your application and data layers to keep their distance from each other.</p>

<h2>
<a name="registering-connections" class="anchor" href="#registering-connections"><span class="octicon octicon-link"></span></a>Registering connections</h2>

<p>Before being able to use Daodalus you will need to create and register one or more connections to your instance (or instances) of MongoDB. Here's how you do it:</p>

<pre><code>conn = Mongo::MongoClient.new('localhost', 27017, pool_size: 5)
Daodalus::Connection.register(conn, :name)
</code></pre>

<p>If you leave off the name, the connection will be registered as <code>:default</code>.</p>

<p>The connection can be any MongoDB connection class provided by the Ruby Mongo Driver - so you could also use a <code>MongoShardedClient</code> or <code>MongoReplicaSetClient</code> here.</p>

<h2>
<a name="creating-a-dao" class="anchor" href="#creating-a-dao"><span class="octicon octicon-link"></span></a>Creating a DAO</h2>

<p>Create a DAO by specifying a database and collection (and optional connection name, defaulting to 'default'):</p>

<pre><code>dao = Daodalus::DAO.new(:my_db, :my_collection, :my_connection)
</code></pre>

<p>The <code>connection</code> name must match one of the connections you registered earlier.</p>

<h2>
<a name="access-to-mongodb-collection-methods" class="anchor" href="#access-to-mongodb-collection-methods"><span class="octicon octicon-link"></span></a>Access to MongoDB Collection Methods</h2>

<p>You now have access to several basic MongoDB methods as defined on the <code>Mongo::Collection</code> class of the MongoDB Ruby driver. The following methods work unchanged:</p>

<ul>
<li><code>find</code></li>
<li><code>update</code></li>
<li><code>insert</code></li>
<li><code>save</code></li>
<li><code>remove</code></li>
<li><code>count</code></li>
<li><code>aggregate</code></li>
</ul><p>However, <code>find_one</code> and <code>find_and_modify</code> work slightly differently. While the original methods return either the matched document or <code>nil</code>, Daodalus is allergic to <code>nil</code>s, and so avoids them by using optional types instead. So the values returned will be either <code>Some[value]</code> or <code>None</code>. You can read more about optional types and see the implementation used by Daodalus <a href="http://github.com/rsslldnphy/optional">here</a>.</p>

<p>These are the only methods exposed by the Daodalus DAO - but should you need to call any other methods on the collection, the <code>Mongo::Collection</code> object can be accessed directly by calling <code>dao.coll</code>.</p>

<h2>
<a name="queries" class="anchor" href="#queries"><span class="octicon octicon-link"></span></a>Queries</h2>

<p>Queries are built up by chaining together one or more 'where' clauses, like this:</p>

<pre><code>dao.where(:name).eq('Terry').and(:paws).gte(3).find
</code></pre>

<p>Note that a longer-form version of the clause name usually exists as an alias if you prefer to be a bit more verbose. So the above could equally be expressed as:</p>

<pre><code>dao.where(:name).equals('Terry').and(:paws).greater_than_or_equal(3).find
</code></pre>

<p>Notice the <code>find</code> at the end of the chain? This is what terminates the chain and sends your query to Mongo. You can also use <code>find_one</code> here (which, remember, will return an <code>Option</code>) as well as some other methods for updating and aggregation that we'll come to later.</p>

<p>Here is the complete list of currently implemented 'where' clauses you can use with Daodalus.</p>

<table>
<tr>
<th>Clause</th>
<th>Alias</th>
<th>Usage</th>
<th>As Mongo</th>
</tr>
<tr>
<td><code>eq</code></td>
<td><code>equals</code></td>
<td><code>dao.where(:paws).eq(4)</code></td>
<td><code>{ 'paws' : 4 }</code></td>
</tr>
<tr>
<td><code>ne</code></td>
<td><code>not_equal</code></td>
<td><code>dao.where(:paws).ne(4)</code></td>
<td><code>{ 'paws' : { '$ne' =&gt; 4 } }</code></td>
</tr>
</table><p>*
*
*
*
*
*</p>

<h3>
<a name="old-readme-below-this-line" class="anchor" href="#old-readme-below-this-line"><span class="octicon octicon-link"></span></a>Old README below this line</h3>

<h3>
<a name="configuration" class="anchor" href="#configuration"><span class="octicon octicon-link"></span></a>Configuration:</h3>

<pre><code># config/mongo.yml
development:
  animals:
    database: animals_development
    host: localhost
    pool_size: 5
    timeout: 5
    replicate_set_name: animals_development
    servers:
      - { host: localhost, port: 27017 }
</code></pre>

<h3>
<a name="initialisation" class="anchor" href="#initialisation"><span class="octicon octicon-link"></span></a>Initialisation:</h3>

<pre><code># config/initializers/daodalus.rb
Daodalus::Configuration.load('config/mongo.yml', Rails.env)
</code></pre>

<h5>
<a name="examples" class="anchor" href="#examples"><span class="octicon octicon-link"></span></a>Examples:</h5>

<pre><code>#!ruby
class CatDAO
  extend Daodalus::DAO # or `include` if you want an instance of a DAO
  target :animals, :cats # or overide `connection` to supply your own

  def self.example_find
    select(:name).where(:paws).less_than(4).find
  end

  def self.example_find_one
    where(:collar_id).eq("aochc986").find_one
  end

  def self.example_update
    set(:stray, true).where(:address).does_not_exist.update
  end

  def self.example_find_and_modify
    dec(:lives).
      push(:names, "Kitty").
      where(:stray).eq(true).
      and(:cuteness).gt(8).
      find_and_modify(new: true)
  end

  def self.example_remove
    where(:lives).eq(0).remove
  end

  def self.example_aggregation
    match(:lives).gt(3).
      and(:address).exists.
      unwind(:favourite_foods).
      group(:favourite_foods).
      min(min_paws: 'paws').
      sort(:_id).
      limit(10).
      project(:_id).as(:food).and(:min_paws).
      aggregate
  end
end
</code></pre>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p>Daodalus is Copyright Â© 2012-2013 On The Beach Ltd.
It is free software, and may be redistributed under the terms specified in the LICENSE file.</p>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/onthebeach">onthebeach</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>